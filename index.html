<!-- ============================================================
AO-LOGIN-01 | FIL: index.html (repo-root)
Projekt: Lager/Freezer (UI-only / localStorage-first)

Syfte:
- Login-sida (f√∂rnamn + l√∂sen/PIN)
- Skapar session (FRZ_SESSION_V1) och routar till r√§tt roll-sida:
  ADMIN  -> ./admin/freezer.html
  BUYER  -> ./buyer/freezer.html
  PICKER -> ./picker/freezer.html

Policy:
- UI-only (inte "riktig" s√§kerhet)
- Fail-closed: om login misslyckas -> stanna h√§r
- XSS-safe: render med textContent

NY STORAGE-KEY (till√•ten i denna AO):
- FRZ_SESSION_V1  (sessionStorage-first, localStorage fallback)

Demo-konton (tills AO-LOGIN-02 g√∂r admin-skapade users persistenta):
- Admin / 1111  -> ADMIN
- Ink√∂p / 2222  -> BUYER
- Plock / 3333  -> PICKER
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lager ‚Äì Logga in</title>

  <link rel="icon" href="data:,">

  <style>
    :root { color-scheme: light; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7f8; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px 14px; }
    .top { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .brand { font-weight:800; letter-spacing:.2px; }
    .muted { opacity:.75; }
    .spacer { flex:1; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #e6e6e6; background:#fff; font-size: 13px; }
    .panel { border:1px solid #e6e6e6; border-radius: 14px; padding: 14px; background:#fff; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size: 13px; margin-bottom: 6px; }
    input { width:100%; box-sizing:border-box; padding:10px 12px; border-radius: 12px; border:1px solid #e6e6e6; background:#fff; font-size: 15px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { border:1px solid #e6e6e6; background:#fff; border-radius: 12px; padding:10px 12px; cursor:pointer; }
    .btn.primary { font-weight:800; }
    .btn[disabled] { opacity:.55; cursor:not-allowed; }
    .msg { border:1px solid #f2b8b5; background:#fff5f5; border-radius: 12px; padding: 10px 12px; }
    .ok { border-color:#cfe9cf; background:#f4fff4; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .small { font-size: 12px; }
    footer { padding: 14px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">üì¶ Lager</div>
      <div class="muted">‚Ä¢ Login</div>
      <div class="spacer"></div>
      <div class="pill" id="sessPill"><span class="muted">Session:</span> <b id="sessText">‚Äî</b></div>
      <button class="btn" id="logoutBtn" type="button" hidden>Logga ut</button>
    </div>

    <div style="height:12px;"></div>

    <section class="panel">
      <div class="grid">
        <div>
          <h1 style="margin:0 0 6px 0;">Logga in</h1>
          <div class="muted" style="margin-bottom:12px;">
            UI-only demo. Detta ger rollstyrd navigation, inte ‚Äúriktig‚Äù s√§kerhet.
          </div>

          <div id="msgBox" class="msg" hidden>
            <b id="msgTitle">Fel</b>
            <div class="muted" id="msgText">‚Äî</div>
          </div>

          <div style="height:12px;"></div>

          <div class="grid" style="grid-template-columns: 1fr; gap:10px;">
            <div>
              <label for="firstName">F√∂rnamn</label>
              <input id="firstName" type="text" autocomplete="username" placeholder="t.ex. Admin" maxlength="32">
            </div>
            <div>
              <label for="pin">L√∂sen/PIN</label>
              <input id="pin" type="password" autocomplete="current-password" placeholder="t.ex. 1111" maxlength="32">
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="row">
            <button class="btn primary" id="loginBtn" type="button">Logga in</button>
            <button class="btn" id="openAdminBtn" type="button" title="√ñppna admin (kr√§ver session)">√ñppna Admin</button>
          </div>

          <div style="height:12px;"></div>

          <div class="muted small">
            Demo-konton (tills AO-LOGIN-02):
            <div><code>Admin / 1111</code> ‚Üí ADMIN</div>
            <div><code>Ink√∂p / 2222</code> ‚Üí BUYER</div>
            <div><code>Plock / 3333</code> ‚Üí PICKER</div>
          </div>
        </div>

        <div>
          <h2 style="margin:0 0 6px 0;">Var hamnar jag?</h2>
          <div class="muted" style="margin-bottom:10px;">
            N√§r du loggar in skickas du direkt till din roll-sida.
          </div>

          <div class="panel" style="background:#fafafa;">
            <div class="row" style="align-items:flex-start;">
              <div style="min-width:120px;"><b>ADMIN</b></div>
              <div class="muted"><code>./admin/freezer.html</code></div>
            </div>
            <div class="row" style="align-items:flex-start; margin-top:8px;">
              <div style="min-width:120px;"><b>INK√ñP</b></div>
              <div class="muted"><code>./buyer/freezer.html</code></div>
            </div>
            <div class="row" style="align-items:flex-start; margin-top:8px;">
              <div style="min-width:120px;"><b>PLOCK</b></div>
              <div class="muted"><code>./picker/freezer.html</code></div>
            </div>
          </div>

          <div style="height:10px;"></div>

          <div class="muted small">
            Fail-closed: om session saknas eller √§r trasig ‚Üí du stannar h√§r.
          </div>
        </div>
      </div>
    </section>

    <footer class="muted small">
      AO-LOGIN-01 ‚Ä¢ FRZ_SESSION_V1 ‚Ä¢ UI-only
    </footer>
  </div>

  <script>
    (function(){
      "use strict";

      const KEY = "FRZ_SESSION_V1";

      const $ = (id) => document.getElementById(id);

      const firstNameEl = $("firstName");
      const pinEl = $("pin");
      const loginBtn = $("loginBtn");
      const logoutBtn = $("logoutBtn");
      const openAdminBtn = $("openAdminBtn");

      const sessText = $("sessText");
      const sessPill = $("sessPill");

      const msgBox = $("msgBox");
      const msgTitle = $("msgTitle");
      const msgText = $("msgText");

      const ROLE_TO_PATH = {
        ADMIN: "./admin/freezer.html",
        BUYER: "./buyer/freezer.html",
        PICKER: "./picker/freezer.html"
      };

      // Demo users (AO-LOGIN-02 ers√§tter med admin-skapade users)
      const DEMO = [
        { firstName: "Admin", pin: "1111", role: "ADMIN" },
        { firstName: "Ink√∂p", pin: "2222", role: "BUYER" },
        { firstName: "Plock", pin: "3333", role: "PICKER" }
      ];

      function safeJsonParse(raw){
        try { return JSON.parse(raw); } catch { return null; }
      }

      function readSession(){
        try {
          const sRaw = (window.sessionStorage && window.sessionStorage.getItem(KEY)) || null;
          if (sRaw) return safeJsonParse(sRaw);
        } catch {}
        try {
          const lRaw = (window.localStorage && window.localStorage.getItem(KEY)) || null;
          if (lRaw) return safeJsonParse(lRaw);
        } catch {}
        return null;
      }

      // GUARD: skriv till B√ÖDE sessionStorage + localStorage (best-effort)
      // Varf√∂r: robust p√• GitHub Pages/redirects. Admin-sidan l√§ser sessionStorage f√∂rst men kan falla tillbaka.
      function writeSession(obj){
        const payload = JSON.stringify(obj);
        let wrote = false;

        try {
          if (window.sessionStorage) {
            window.sessionStorage.setItem(KEY, payload);
            wrote = true;
          }
        } catch {}

        try {
          if (window.localStorage) {
            window.localStorage.setItem(KEY, payload);
            wrote = true;
          }
        } catch {}

        return wrote;
      }

      function clearSession(){
        try { window.sessionStorage && window.sessionStorage.removeItem(KEY); } catch {}
        try { window.localStorage && window.localStorage.removeItem(KEY); } catch {}
      }

      function showMsg(title, text){
        if (!msgBox) return;
        msgTitle.textContent = title || "Info";
        msgText.textContent = text || "‚Äî";
        msgBox.hidden = false;
      }

      function clearMsg(){
        if (!msgBox) return;
        msgBox.hidden = true;
        msgTitle.textContent = "Info";
        msgText.textContent = "‚Äî";
      }

      function normalizeName(s){
        return String(s || "").trim();
      }

      function findDemoUser(firstName, pin){
        const n = normalizeName(firstName);
        const p = String(pin || "").trim();
        if (!n || !p) return null;

        const lower = n.toLowerCase();
        for (const u of DEMO) {
          if (!u) continue;
          if (String(u.firstName || "").toLowerCase() === lower && String(u.pin || "") === p) return u;
        }
        return null;
      }

      function getTargetPath(role){
        const r = String(role || "").toUpperCase().trim();
        return ROLE_TO_PATH[r] || "";
      }

      function gotoRole(role){
        const target = getTargetPath(role);
        if (!target) return;
        try { window.location.assign(target); } catch {}
      }

      function renderSessionPill(){
        const s = readSession();
        if (!s || typeof s !== "object") {
          sessText.textContent = "Ingen";
          sessPill.classList.remove("ok");
          logoutBtn.hidden = true;
          return;
        }
        const role = String(s.role || "").toUpperCase();
        const name = String(s.firstName || "");
        sessText.textContent = (name && role) ? (name + " ‚Ä¢ " + role) : "OK";
        sessPill.classList.add("ok");
        logoutBtn.hidden = false;
      }

      function onLogin(){
        clearMsg();

        const firstName = normalizeName(firstNameEl.value);
        const pin = String(pinEl.value || "").trim();

        if (!firstName) return showMsg("Fel", "F√∂rnamn kr√§vs.");
        if (!pin) return showMsg("Fel", "L√∂sen/PIN kr√§vs.");

        const u = findDemoUser(firstName, pin);
        if (!u) return showMsg("Fel", "Fel f√∂rnamn eller l√∂sen/PIN.");

        const now = Date.now();
        const session = {
          v: 1,
          firstName: u.firstName,
          role: u.role,
          at: now,
          // Demo: 12h session
          exp: now + (12 * 60 * 60 * 1000)
        };

        const ok = writeSession(session);
        if (!ok) return showMsg("Fel", "Kunde inte spara session (storage blockad).");

        renderSessionPill();
        gotoRole(u.role);
      }

      function onLogout(){
        clearSession();
        renderSessionPill();
        clearMsg();
        try {
          firstNameEl.value = "";
          pinEl.value = "";
          firstNameEl.focus();
        } catch {}
      }

      function enforceExpiry(){
        const s = readSession();
        if (!s || typeof s !== "object") return;
        const exp = Number(s.exp || 0);
        if (exp && Date.now() > exp) {
          clearSession();
        }
      }

      // Wire
      loginBtn.addEventListener("click", onLogin);
      logoutBtn.addEventListener("click", onLogout);

      openAdminBtn.addEventListener("click", () => {
        clearMsg();
        enforceExpiry();
        const s = readSession();
        if (!s || typeof s !== "object") return showMsg("Sp√§rrad", "Ingen session. Logga in f√∂rst.");
        if (String(s.role || "").toUpperCase() !== "ADMIN") return showMsg("Sp√§rrad", "Endast ADMIN kan √∂ppna Admin-sidan.");
        gotoRole("ADMIN");
      });

      // Enter = login
      document.addEventListener("keydown", (e) => {
        if (!e) return;
        if (e.key === "Enter") {
          onLogin();
        }
      });

      // Boot
      enforceExpiry();
      renderSessionPill();
      try { firstNameEl.focus(); } catch {}

    })();
  </script>

  <!-- ==========================================================
  √ÑNDRINGSLOGG (‚â§8)
  1) GUARD: writeSession skriver nu best-effort till b√•de sessionStorage + localStorage.
  2) Robustare redirect-fl√∂de: admin-sidan kan alltid l√§sa FRZ_SESSION_V1 via fallback.
  =========================================================== -->

  <!-- ==========================================================
  TESTNOTERINGAR (klicktest)
  - √ñppna /Lager/index.html -> logga in Admin/1111 -> ska hamna i /Lager/admin/freezer.html
  - Om admin kickar tillbaka: Application -> Local Storage ska fortfarande ha FRZ_SESSION_V1
  - Logga ut -> session pill ska visa "Ingen"
  =========================================================== -->
</body>
</html>
